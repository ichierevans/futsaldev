name: Deploy Laravel ke VPS

on:
  push:
    branches: [ main ] # Trigger workflow ketika ada push ke branch 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest # Menggunakan runner GitHub Actions terbaru

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master # Menggunakan action SSH untuk koneksi ke VPS
        with:
          host: ${{ secrets.VPS_IP }} # IP VPS dari GitHub Secrets
          username: ${{ secrets.VPS_USER }} # Username SSH VPS dari GitHub Secrets
          key: ${{ secrets.VPS_SSH_KEY }} # SSH Private Key VPS dari GitHub Secrets
          script: |
            echo "üìÅ Masuk ke direktori proyek di host..."
            cd /var/www/futsaldev
            
            echo "üîÑ Konfigurasi Git safe.directory di host..."
            # Jika error "dubious ownership" masih muncul untuk /var/www, Anda mungkin perlu menambahkan ini:
            # git config --global --add safe.directory /var/www
            git config --global --add safe.directory /var/www/futsaldev
            
            echo "üîÑ Update kode dari branch main di host..."
            git fetch origin
            git reset --hard origin/main
            
            echo "üßπ Hentikan container lama..."
            docker compose down
            
            echo "‚öô Bangun dan jalankan container baru..."
            docker compose up -d --build
            
            echo "‚è≥ Tunggu MySQL siap di dalam container..."
            # Menunggu hingga container MySQL siap menerima koneksi
            docker exec laravel-app sh -c '
              max_tries=30
              counter=0
              until php -r "
                try {
                  # Mencoba koneksi PDO ke database MySQL
                  # Pastikan host, port, dbname, user, dan password sesuai dengan konfigurasi Docker Compose Anda
                  \$pdo = new PDO(
                    \"mysql:host=db;port=3306;dbname=futsal6\",
                    \"root\",
                    \"root\"
                  );
                  exit(0);
                } catch (PDOException \$e) {
                  exit(1);
                }
              " || [ $counter -eq $max_tries ]; do
                echo "Mencoba koneksi ke database... ($counter/$max_tries)"
                sleep 2
                counter=$((counter+1))
              done
              if [ $counter -eq $max_tries ]; then
                echo "‚ùå Timeout menunggu database"
                exit 1
              fi
            '
            
            echo "‚öô Atur permission direktori aplikasi utama di dalam container..."
            # Pastikan user www-data memiliki izin tulis ke direktori aplikasi utama di dalam container
            # Diasumsikan direktori aplikasi Laravel di dalam container adalah /var/www
            docker exec laravel-app chmod -R 775 /var/www
            docker exec laravel-app chown -R www-data:www-data /var/www
            
            echo "‚öô Atur permission storage dan bootstrap/cache di dalam container..."
            # Mengatur kepemilikan dan izin direktori storage dan bootstrap/cache di dalam container
            docker exec laravel-app chown -R www-data:www-data storage bootstrap/cache
            docker exec laravel-app chmod -R 775 storage bootstrap/cache
            
            echo "üìÑ Buat file .env jika belum ada di dalam container..."
            # Laravel memerlukan file .env. Jika tidak ada (karena .env biasanya di .gitignore),
            # buat dari .env.example
            docker exec laravel-app sh -c '
              if [ ! -f .env ]; then
                cp .env.example .env
                echo ".env created from .env.example"
              else
                echo ".env already exists"
              fi
            '
            
            echo "üì¶ Jalankan composer install di dalam container..."
            docker exec -u www-data laravel-app composer install --no-interaction --prefer-dist --optimize-autoloader
            
            echo "üîê Generate APP key di dalam container..."
            docker exec -u www-data laravel-app php artisan key:generate --force
            
            echo "üßπ Bersihkan cache aplikasi di dalam container..."
            docker exec -u www-data laravel-app php artisan config:clear
            docker exec -u www-data laravel-app php artisan cache:clear
            
            echo "üóÉ Migrasi dan seed database di dalam container..."
            # Menjalankan migrasi database di dalam container
            # PENTING: migrate:fresh akan MENGHAPUS SEMUA DATA di database Anda.
            # Untuk produksi, biasanya Anda hanya ingin 'php artisan migrate --force'
            # yang hanya menjalankan migrasi yang belum dijalankan.
            docker exec -u www-data laravel-app php artisan migrate --force --seed
            # Jika Anda memang ingin menghapus semua data dan me-reset database setiap kali deploy:
            # docker exec -u www-data laravel-app php artisan migrate:fresh --force --seed
            
            echo "‚úÖ Deploy selesai!"
