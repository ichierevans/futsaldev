name: Deploy Laravel ke VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "📁 Masuk ke direktori proyek..."
            cd /var/www/futsaldev
            
            echo "🔄 Konfigurasi Git safe.directory..."
            git config --global --add safe.directory /var/www/futsaldev
            
            echo "🔄 Update kode dari branch main..."
            git fetch origin
            git reset --hard origin/main
            
            echo "🧹 Hentikan container lama..."
            docker compose down
            
            echo "⚙ Bangun dan jalankan container baru..."
            docker compose up -d --build
            
            echo "⏳ Tunggu MySQL siap..."
            docker exec laravel-app sh -c '
              max_tries=30
              counter=0
              until php -r "
                try {
                  \$pdo = new PDO(
                    \"mysql:host=db;port=3306;dbname=futsal6\",
                    \"root\",
                    \"root\"
                  );
                  exit(0);
                } catch (PDOException \$e) {
                  exit(1);
                }
              " || [ $counter -eq $max_tries ]; do
                echo "Mencoba koneksi ke database... ($counter/$max_tries)"
                sleep 2
                counter=$((counter+1))
              done
              if [ $counter -eq $max_tries ]; then
                echo "❌ Timeout menunggu database"
                exit 1
              fi
            '
            
            echo "⚙ Atur permission storage dan bootstrap/cache..."
            docker exec laravel-app chown -R www-data:www-data storage bootstrap/cache
            docker exec laravel-app chmod -R 775 storage bootstrap/cache
            
            echo "📦 Jalankan composer install..."
            docker exec -u www-data laravel-app composer install --no-interaction --prefer-dist --optimize-autoloader
            
            echo "🔐 Generate APP key..."
            docker exec -u www-data laravel-app php artisan key:generate --force
            
            echo "🧹 Bersihkan cache aplikasi..."
            docker exec -u www-data laravel-app php artisan config:clear
            docker exec -u www-data laravel-app php artisan cache:clear
            
            echo "🗃 Migrasi dan seed database..."
            docker exec -u www-data laravel-app php artisan migrate:fresh --force --seed
            
            echo "✅ Deploy selesai!"
